<!doctype html>
<html>
<head>

<title>MLB</title>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="../bootstrap.min.js"></script>
<link href="../bootstrap.min.css" rel="stylesheet">
<link href="../bootstrap-theme.min.css" rel="stylesheet">
</head>
<body>

<script>
const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
let gamepk = urlParams.get('gamepk');
console.log(gamepk);

var previous = null;
var current = null;

function getData(url){
  $.getJSON(livefeedurl, function(data2) {
      console.log(data2);
      document.getElementById("hometeamval").innerHTML = "<b>Home:</b> "+data2.gameData.teams.home.name;
      document.getElementById("awayteamval").innerHTML = "<b>Away:</b> "+data2.gameData.teams.away.name;
      document.getElementById("awayteamscore").innerHTML = gamedata.teams.away.score;
      var year = data2.metaData.timeStamp.substring(0,4);
      var month = data2.metaData.timeStamp.substring(4,6);
      var day = data2.metaData.timeStamp.substring(6,8);
      var hour = data2.metaData.timeStamp.substring(9,11);
      var minute = data2.metaData.timeStamp.substring(11,13);
      var second = data2.metaData.timeStamp.substring(13,15);
      document.getElementById("timestamp").innerHTML = month+"/"+day+"/"+year+" "+hour+":"+minute+":"+second;
      var atBatIndex = parseInt(data2.liveData.plays.currentPlay.atBatIndex);
      console.log(atBatIndex);
      var currentPlay = data2.liveData.plays.allPlays[atBatIndex];
      if (data2.liveData.plays.allPlays[atBatIndex].playEvents.length==0){
      document.getElementById("status").innerHTML = "Waiting for pitch";
      } else{
      var currentPitch = data2.liveData.plays.allPlays[atBatIndex].playEvents[data2.liveData.plays.allPlays[atBatIndex].playEvents.length-1];
      console.log(currentPlay);
      console.log(currentPitch);
      if (currentPitch.hasOwnProperty("pitchData")){
        document.getElementById("status").innerHTML = "Pitch "+data2.liveData.plays.allPlays[atBatIndex].playEvents.length;
        document.getElementById("pitchspeed").innerHTML = currentPitch.pitchData.endSpeed+" mph";
        document.getElementById("count").innerHTML = currentPitch.count.balls+"-"+currentPitch.count.strikes;
        document.getElementById("call").innerHTML = currentPitch.details.call.description;
      } else{
        document.getElementById("status").innerHTML = currentPitch.details.description;
      }
      }
      document.getElementById("pitcher").innerHTML = currentPlay.matchup.pitcher.fullName;
      document.getElementById("batter").innerHTML = currentPlay.matchup.batter.fullName;
  });
}

var livefeedurl = "https://statsapi.mlb.com/api/v1.1/game/"+gamepk+"/feed/live"

getData(livefeedurl);



setInterval(function() {
  getData(livefeedurl);
//  $.getJSON('https://statsapi.mlb.com/api/v1/schedule/?sportId=1&teamId=114&hydrate=linescore', function(data) {
//    // TODO if there's more than one game in a day, need to change this
//    var gamedata = (data.dates[0].games[0]);
//    document.getElementById("hometeamscore").innerHTML = gamedata.teams.home.score;
//    document.getElementById("awayteamval").innerHTML = "<b>Away:</b> "+gamedata.teams.away.team.name;
//    document.getElementById("awayteamscore").innerHTML = gamedata.teams.away.score;
//    var numouts = parseInt(gamedata.linescore.outs);
//    if (numouts==1){
//      document.getElementById("inning").innerHTML = gamedata.linescore.inningHalf+" of the "+gamedata.linescore.currentInningOrdinal+", "+gamedata.linescore.outs+" out";
//    } else{
//      document.getElementById("inning").innerHTML = gamedata.linescore.inningHalf+" of the "+gamedata.linescore.currentInningOrdinal+", "+gamedata.linescore.outs+" outs";
//    }
    //document.getElementById("count").innerHTML = gamedata.linescore.balls+"-"+gamedata.linescore.strikes+" count";
    //document.getElementById("batter").innerHTML = gamedata.linescore.defense.batter.fullName;
    //var gamePk = gamedata.gamePk;
//    $.getJSON(livefeedurl, function(data2) {
//      console.log(data2);
//      document.getElementById("hometeamval").innerHTML = "<b>Home:</b> "+data2.gameData.teams.home.name;
//      document.getElementById("awayteamval").innerHTML = "<b>Away:</b> "+data2.gameData.teams.away.name;
//      var year = data2.metaData.timeStamp.substring(0,4);
//      var month = data2.metaData.timeStamp.substring(4,6);
//      var day = data2.metaData.timeStamp.substring(6,8);
//      var hour = data2.metaData.timeStamp.substring(9,11);
//      var minute = data2.metaData.timeStamp.substring(11,13);
//      var second = data2.metaData.timeStamp.substring(13,15);
//      document.getElementById("timestamp").innerHTML = month+"/"+day+"/"+year+" "+hour+":"+minute+":"+second;
//      var atBatIndex = parseInt(data2.liveData.plays.currentPlay.atBatIndex);
//      console.log(atBatIndex);
//      var currentPlay = data2.liveData.plays.allPlays[atBatIndex];
//      if (data2.liveData.plays.allPlays[atBatIndex].playEvents.length==0){
//        document.getElementById("status").innerHTML = "Waiting for pitch";
//      } else{
//        var currentPitch = data2.liveData.plays.allPlays[atBatIndex].playEvents[data2.liveData.plays.allPlays[atBatIndex].playEvents.length-1];
//        console.log(currentPlay);
//        console.log(currentPitch);
//        if (currentPitch.hasOwnProperty("pitchData")){
//          document.getElementById("status").innerHTML = "Pitch "+data2.liveData.plays.allPlays[atBatIndex].playEvents.length;
//          document.getElementById("pitchspeed").innerHTML = currentPitch.pitchData.endSpeed+" mph";
//          document.getElementById("count").innerHTML = currentPitch.count.balls+"-"+currentPitch.count.strikes;
//          document.getElementById("call").innerHTML = currentPitch.details.call.description;
//        } else{
//          document.getElementById("status").innerHTML = currentPitch.details.description;
//        }
//      }
//      document.getElementById("pitcher").innerHTML = currentPlay.matchup.pitcher.fullName;
//      document.getElementById("batter").innerHTML = currentPlay.matchup.batter.fullName;
//      current = JSON.stringify(data2);
//      if (previous && current && previous !== current) {
//      console.log('refresh');
//      location.reload();
//      }
//      previous = current;
//    });
//  });
}, 200000);
</script>

<br><br>
<center>
<div class="container">
  <h2 id="inning"></h2>
  <div id="timestamp"></div><br>
  <table class="table w-auto">
    <tbody>
      <tr>
        <td id="hometeamval"></td>
        <td id="hometeamscore"></td>
      </tr>
      <tr>
        <td id="awayteamval"></td>
        <td id="awayteamscore"></td>
      </tr>
    </tbody>
  </table>
</div>
<br>
<div class="container">
  <h2 id="status"></h2><br>
  <table class="table w-auto">
    <tbody>
      <tr>
        <td>Pitcher</td>
        <td id="pitcher"></td>
      </tr>
      <tr>
        <td>Batter</td>
        <td id="batter"></td>
      </tr>
      <tr>
        <td>Pitch Speed</td>
        <td id="pitchspeed"></td>
      </tr>
      <tr>
        <td>Call</td>
        <td id="call"></td>
      </tr>
      <tr>
        <td>Count</td>
        <td id="count"></td>
      </tr>
    </tbody>
  </table>
</div>
</center>

</body>
</html>
